3.2.1 Быстрый старт

Датчик настраивается путем записи в набор управляющих регистров (подробный список всех доступных регистров и их
описания см. в Главе 5). В этом разделе с помощью простого пошагового примера показано, как настроить датчик для
простых измерений в принудительном режиме с одной уставкой нагревателя. Более подробное описание процесса измерения
см. в разделе 3.3.

В этом примере датчик будет настроен на использование 2-кратной передискретизации для измерения температуры,
16-кратной передискретизации для сигнала давления и 1-кратной передискретизации для влажности.
Кроме того, горячая пластина датчика газа будет настроена на нагрев в течение 100 мс при температуре 300 °C перед
выполнением измерения газа.

Во-первых, пользователь должен настроить параметры передискретизации для температуры, давления и влажности,
установив регистры управления osrs_t<2:0> и osrs_h<2:0> соответственно. Поддерживаемые настройки варьируются от
16-кратной передискретизации до 0x, что эквивалентно пропуску соответствующего дополнительного измерения.
Дополнительные сведения см. в разделе 5.3.2.

    1. Установите передискретизацию влажности в 1x, записав 0b001 в osrs_h<2:0>.
    2. Установите передискретизацию температуры в 2х, записав 0b010 в osrs_t<2:0>.
    3. Установите передискретизацию давления в 16x, записав 0b101 в osrs_p<2:0>.

Настоятельно рекомендуется установить сначала osrs_h<2:0>, затем osrs_t<2:0> и osrs_p<2:0>
в одной команде записи (см. Раздел 3.3).

Затем пользователь должен установить по крайней мере одну уставку температуры нагревательной плиты газового датчика
и продолжительность нагрева. Через регистры управления gas_wait_x<7:0> можно настроить до 10 длительностей нагревания,
где x находится в диапазоне от 0 до 9. См. Раздел 5.3.3 для определения содержимого регистра. Соответствующие заданные
значения нагревателя хранятся в регистрах res_heat_x<7:0>. Раздел 3.3.5 объясняет, как преобразовать целевую температуру
нагревателя, например, 300 °C, в код. Для работы в принудительном режиме уставка используемого нагревателя выбирается
путем установки регистра управления nb_conv<3:0> на профиль нагревателя, который будет использоваться, например,
чтобы использовать gas_wait_0<7:0> и res_heat_0<7:0>, nb_conv<3:0> должно быть установлено на 0x0. Наконец,
функциональность датчика газа должна быть включена установкой бита run_gas_l в 1.

    4. Установите для gas_wait_0<7:0> значение 0x59, чтобы выбрать продолжительность нагрева 100 мс.
    5. Установите соответствующую уставку нагревателя, записав целевое сопротивление нагревателя в res_heat_0<7:0>.
    6. Установите nb_conv<3:0> на 0x0, чтобы выбрать ранее определенные настройки нагревателя.
    7. Установите для run_gas_l значение 1, чтобы включить измерения газа.

Теперь одно измерение в принудительном режиме с указанными выше настройками можно запустить,
записав 0b01 в режим <1:0>. Подробнее о считывании данных см. в разделе 5.3.1.3.

    8. Установите mode<1:0> в значение 0b01, чтобы запустить одно измерение.

3.2.2 Процесс настройки датчика
Рисунок 2 иллюстрирует, какие регистры управления должны быть установлены. Подробную информацию об отдельных регистрах
управления см. в главе 5. Более того, подробные сведения о потоке измерений для отдельных режимов
можно найти в разделе 3.3.

                Принудительный режим
                        |
        Выберите передискретизацию для T, P и H
            • Установить osrs_x<2:0>
                        |
        Выберите IIR-фильтр для датчика температуры
            • Установить фильтр <2:0>
                        |
        Включить газовое "покрытие"
            • Установите бит run_gas в значение 1.
                        |
        Выберите индекс уставки нагревателя
            • Установите nb_conv <3:0> (индексация начинается с нуля)
                        |
        Определите время работы нагревателя
            • Преобразование длительности в код регистра
            • Установите gas_wait_x<7:0> (базовая единица времени — мс)
                        |
        Установите температуру нагревателя
            • Преобразование температуры в код регистра
            • Установите res_heat_x<7:0>
                        |
        Установите принудительный режим
            • Установите mode<1:0> в значение 0b01.

3.3 Схема измерения
Ссылаясь на рисунок 1, период измерения BME680 состоит из измерения температуры, давления и влажности с выбираемой
передискретизацией. Кроме того, он содержит фазу нагрева нагревательной пластины датчика газа, а также измерение
сопротивления датчика газа.
После периода измерения данные давления и температуры могут быть пропущены через опциональный IIR-фильтр,
который устраняет кратковременные колебания. Для влажности и газа такой фильтр не нужен и не реализован.

3.3.1 Измерение температуры
Измерение температуры можно включить или пропустить. Обычно не рекомендуется пропускать измерение, поскольку информация
о температуре используется для компенсации влияния температуры на другие параметры. При включении доступно несколько
вариантов передискретизации. Измерение температуры управляется настройкой osrs_t<2:0>, которая подробно описана в
Разделе 5.3.2.2. Для измерения температуры возможна передискретизация для уменьшения шума. Разрешение данных о
температуре зависит от IIR-фильтра (см. раздел 5.3.2.4) и настройки передискретизации:

    • Когда IIR-фильтр включен, разрешение по температуре составляет 20 бит.
    • Когда IIR-фильтр отключен, разрешение по температуре составляет 16 + (osrs_t – 1) бит, т.е. 18 бит,
      когда для osrs_t установлено значение «3»

Используя переменные, перечисленные в таблице 11, следующий код рассчитает компенсированное значение температуры
(в градусах Цельсия). Однако рекомендуется использовать API сенсора, доступный на github (глава 4), для более
удобного взаимодействия с пользователем.

Floating point:
---------------
var1 = (((double)temp_adc / 16384.0) - ((double)par_t1 / 1024.0)) * (double)par_t2;
var2 = ((((double)temp_adc / 131072.0) - ((double)par_t1 / 8192.0)) *
(((double)temp_adc / 131072.0) - ((double)par_t1 / 8192.0))) *
((double)par_t3 * 16.0);
t_fine = var1 + var2;
temp_comp = t_fine / 5120.0;

Integer:
---------
var1 = ((int32_t)temp_adc >> 3) - ((int32_t)par_t1 << 1);
var2 = (var1 * (int32_t)par_t2) >> 11;
var3 = ((((var1 >> 1) * (var1 >> 1)) >> 12) * ((int32_t)par_t3 << 4)) >> 14;
t_fine = var2 + var3;
temp_comp = ((t_fine * 5) + 128) >> 8;

где:
    • par_t1, par_t2 и par_t3 — параметры калибровки,
    • temp_adc — необработанные (сырые) выходные данные температуры.
    • temp_comp — выходные данные с компенсацией температуры в градусах Цельсия.

    Таблица 11: Имена переменных и адреса регистров для расчета temp_comp

    Имя переменной          Адрес регистра (LSB/MSB)
    ------------------------------------------------
    par_t1                  0xE9/0xEA
    par_t2                  0x8A/0x8B
    par_t3                  0x8C
    temp_adc                0x24<7:4>/0x23/0x22

3.3.2 Измерение давления
Измерение давления можно включить или пропустить. При включении доступно несколько вариантов передискретизации.
Измерение давления контролируется настройкой osrs_p<2:0>, которая подробно описана в разделе 5.3.2. Для измерения
давления возможна передискретизация для уменьшения шума. Разрешение данных о давлении зависит от IIR-фильтра
(см. раздел 5.3.2.4) и настройки передискретизации:

    • Когда IIR-фильтр включен, разрешение по давлению составляет 20 бит.
    • Когда IIR-фильтр отключен, разрешение по давлению составляет 16 + (osrs_p – 1) бит, т.е. 18 бит,
      когда для osrs_p установлено значение «3»

Используя переменные, перечисленные в таблице 12, следующий код рассчитает компенсированное значение
давления (в Паскалях). Однако рекомендуется использовать API сенсора, доступный на github (глава 4),
для более удобного взаимодействия с пользователем.

...

3.3.4 IIR-фильтр
Давление окружающей среды подвержено множеству кратковременных изменений, вызванных внешними возмущениями.
Чтобы подавить помехи (например, захлопывание двери или дуновение ветра в датчик) в выходных данных,
не вызывая дополнительного трафика интерфейса и нагрузки на процессор, BME680 оснащен внутренним IIR-фильтром
(см. раздел 5.3.2.4). Это эффективно уменьшает полосу пропускания выходных сигналов температуры и давления и
увеличивает разрешение выходных данных до 20 бит, отмечая, что значения влажности и газа внутри датчика не
колеблются быстро и не требуют фильтрации нижних частот. Выходные данные следующего шага измерения фильтруются
по следующей формуле:
        ........................
IIR-фильтр можно настроить на разные коэффициенты фильтрации, что замедляет реакцию на входные данные датчика.
Обратите внимание, что время отклика с включенным IIR-фильтром зависит от количества сгенерированных выборок,
а это означает, что скорость вывода данных должна быть известна для расчета фактического времени отклика.

При записи в регистровый фильтр фильтр сбрасывается. Следующие значения АЦП пройдут через фильтр без изменений
 и станут начальными значениями памяти для фильтра. Если измерения температуры или давления пропущены,
 соответствующая память фильтра останется неизменной, даже если выходные регистры установлены в 0x80000.
 При повторном включении ранее пропущенного измерения выходные данные будут отфильтрованы с использованием памяти
 фильтра с момента, когда измерение не было пропущено в последний раз. Если это нежелательно, запишите в регистр
 фильтра, чтобы повторно инициализировать фильтр.

3.3.5 Нагрев и измерение датчика газа
Работа газочувствительной части BME680 состоит из двух этапов:
1. Нагрев нагревательной пластины датчика газа до заданной температуры (обычно от 200 °C до 400 °C) и поддержание
этой температуры в течение определенного периода времени.
2. Измерение сопротивления газочувствительного слоя.

Можно настроить до 10 различных уставок температуры нагревательной пластины, установив регистры res_heat_x<7:0>,
где x = 0…9. Внутренний контур управления нагревателем работает на сопротивлении конструкции нагревателя.
Следовательно, пользователю сначала необходимо преобразовать целевую температуру в целевое сопротивление
устройства, прежде чем записать полученный код регистра в память датчика.

Используя переменные, перечисленные в Таблице 14: Имена переменных и адреса регистров для вычисления res_heat_x,
следующий код вычислит код регистра, который будет записан в res_heat_x<7:0>. Однако рекомендуется использовать
API сенсора, доступный на github (глава 4), для более удобного взаимодействия с пользователем.

где:
    -   par_g1, par_g2, par_g3 параметры калибровки
    -   target_temp — целевая температура нагревателя в градусах Цельсия
    -   amb_temp — температура окружающей среды (жестко заданная или считанная с датчика температуры)
    -   var5 — целевое сопротивление нагревателя в Омах
    -   res_heat_x — это десятичное значение, которое необходимо сохранить в регистре,
        где «x» соответствует номеру температурного профиля от 0 до 9.
    -   res_heat_range — это диапазон нагревателя, хранящийся в регистре с адресом 0x02 <5:4>
    -   res_heat_val — поправочный коэффициент сопротивления нагревателя, хранящийся в регистре
        по адресу 0x00 (со знаком, значение от -128 до 127)


5.3.2.4 Управление IIR фильтром – filter
IIR-фильтр применяется к данным о температуре и давлении, но не к данным о влажности и газе. Данные, поступающие от АЦП,
фильтруются, а затем загружаются в регистры данных. Регистры результатов температуры и давления обновляются одновременно
в конце измерения. Выходное разрешение IIR-фильтра составляет 20 бит. Регистры результатов сбрасываются на значение
0x80000, если измерения температуры и/или давления были пропущены (osrs_x=”000‟). Соответствующая память фильтра
остается неизменной (сохраняется значение последнего измерения). Когда соответствующий регистр OSRS устанавливается
обратно в ненулевое значение, первое значение, сохраненное в регистрах результатов, фильтруется.